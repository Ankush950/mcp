Create Machine Config Pool for infra nodes


• Add a label infra to infra1, infra2 and infra3 nodes
[igaocpadmin@iga-ocp-ubh01 ~]$ oc label nodes iga-ocp-uiw01.goindigo.in iga-ocp-uiw02.goindigo.in iga-ocp-uiw03.goindigo.in node-role.kubernetes.io/infra=""
node/iga-ocp-uiw01.goindigo.in labeled
node/iga-ocp-uiw02.goindigo.in labeled
node/iga-ocp-uiw03.goindigo.in labeled

• Verify the new role infra added in infra1, infra2 and infra3 node
[igaocpadmin@iga-ocp-ubh01 ~]$ oc get node iga-ocp-uiw01.goindigo.in iga-ocp-uiw02.goindigo.in iga-ocp-uiw03.goindigo.in
NAME STATUS ROLES AGE VERSION
iga-ocp-uiw01.goindigo.in Ready infra,worker 11m10s v1.23.5+a36406b
iga-ocp-uiw02.goindigo.in Ready infra,worker 12m18s v1.23.5+a36406b
iga-ocp-uiw03.goindigo.in Ready infra,worker 12m18s v1.23.5+a36406b

• Remove a role worker in infra1, infra2 and infra3 role
[igaocpadmin@iga-ocp-ubh01 ~]$ oc label nodes iga-ocp-uiw01.goindigo.in iga-ocp-uiw02.goindigo.in iga-ocp-uiw03.goindigo.in node-role.kubernetes.io/worker-
node/iga-ocp-uiw01.goindigo.in labeled
node/iga-ocp-uiw02.goindigo.in labeled
node/iga-ocp-uiw03.goindigo.in labeled

• Verify the role of infra1, infra2 and infra3 nodes
[igaocpadmin@iga-ocp-ubh01 ~]$ oc get node iga-ocp-uiw01.goindigo.in iga-ocp-uiw02.goindigo.in iga-ocp-uiw03.goindigo.in
NAME STATUS ROLES AGE VERSION
iga-ocp-uiw01.goindigo.in Ready infra 11m10s v1.23.5+a36406b
iga-ocp-uiw02.goindigo.in Ready infra 12m18s v1.23.5+a36406b
iga-ocp-uiw03.goindigo.in Ready infra 12m18s v1.23.5+a36406b

• Create a MachineConfigPool for infra nodes
[igaocpadmin@iga-ocp-ubh01 indigo-uat]$ vi infra-mcp.yaml
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
name: infra
spec:
machineConfigSelector:
matchExpressions:
- {key: machineconfiguration.openshift.io/role, operator: In, values: [worker,infra]}
nodeSelector:
matchLabels:
node-role.kubernetes.io/infra: ""
[igaocpadmin@iga-ocp-ubh01 indigo-uat]$ oc create -f infra-mcp.yaml
machineconfigpool.machineconfiguration.openshift.io/infra created

• Verify the MCP infra created with 3 ready machine count of infra nodes
[igaocpadmin@iga-ocp-ubh01 indigo-uat]$ oc get mcp infra
NAME CONFIG UPDATED UPDATING DEGRADED MACHINECOUNT READYMACHINECOUNT UPDATEDMACHINECOUNT DEGRADEDMACHINECOUNT AGE
infra rendered-infra-b96bd504af26817dbb3ce4b0fc078a0c True False False 3 3 3 0 15d

----------------------------------------------------------------------------------------
5.2.4. Move Ingress Controller components to infra nodes

• Check router pods running status (They could be running inside any of the infra and worker nodes)
[igaocpadmin@iga-ocp-ubh01 indigo-uat]$ oc get pods -o wide -n openshift-ingress
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
router-default-77d4db8d9-r6krc 1/1 Running 0 33h 10.1.10.143 iga-ocp-uaw01.goindigo.in <none> <none>
router-default-77d4db8d9-rf7zq 1/1 Running 0 33h 10.1.9.91 iga-ocp-uiw01.goindigo.in <none> <none>
router-default-77d4db8d9-vgdn5 1/1 Running 0 33h 10.1.10.162 iga-ocp-uaw02.goindigo.in <none> <none>

• Move ingresscontroller (router pods) to the infra nodes and edit the replica count to 2
[igaocpadmin@iga-ocp-ubh01 indigo-uat]$ oc edit ingresscontroller default -n openshift-ingress-operator
ingresscontroller.operator.openshift.io/default edited
................
spec:
nodePlacement:
nodeSelector:
matchLabels:
node-role.kubernetes.io/infra: ""
replicas: 2
.................

• Verify that the router pods are running on infra nodes
[igaocpadmin@iga-ocp-ubh01 indigo-uat]$ oc get pods -o wide -n openshift-ingress
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
router-default-67c4cd4f87-w8s4z 1/1 Running 0 6d22h 10.1.9.91 iga-ocp-uiw01.goindigo.in <none> <none>
router-default-67c4cd4f87-wdtb6 1/1 Running 0 6d22h 10.1.9.90 iga-ocp-uiw02.goindigo.in <none> <none>